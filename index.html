<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fantacalcio Wendy — Svincolati</title>
  <style>
    :root { --bg:#0b0c10; --card:#12131a; --text:#e8e8ea; --muted:#a7a7b3; --line:#262836; --accent:#6ee7b7; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    header { padding:18px 18px 10px; border-bottom:1px solid var(--line); position:sticky; top:0; background:rgba(11,12,16,.92); backdrop-filter: blur(8px); }
    h1 { margin:0 0 10px; font-size:18px; font-weight:650; letter-spacing:.2px; }
    .controls { display:grid; grid-template-columns: 1.3fr .6fr .8fr .6fr; gap:10px; align-items:end; }
    .ctrl { display:flex; flex-direction:column; gap:6px; }
    label { font-size:12px; color:var(--muted); }
    input, select { width:100%; padding:10px 10px; border-radius:10px; border:1px solid var(--line); background:var(--card); color:var(--text); outline:none; }
    input:focus, select:focus { border-color: rgba(110,231,183,.5); box-shadow: 0 0 0 3px rgba(110,231,183,.12); }
    main { padding:14px 18px 28px; }
    .meta { display:flex; gap:12px; align-items:center; justify-content:space-between; margin:10px 0 12px; color:var(--muted); font-size:12px; }
    .pill { padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:var(--card); }
    .tableWrap { border:1px solid var(--line); border-radius:14px; overflow:hidden; background:var(--card); }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:10px 10px; border-bottom:1px solid var(--line); font-size:13px; }
    th { position:sticky; top:92px; background:rgba(18,19,26,.96); backdrop-filter: blur(8px); text-align:left; cursor:pointer; user-select:none; }
    th .hint { color:var(--muted); font-weight:500; margin-left:6px; font-size:11px; }
    tr:hover td { background: rgba(110,231,183,.06); }
    .right { text-align:right; }
    .muted { color:var(--muted); }
    .pager { display:flex; gap:8px; align-items:center; justify-content:flex-end; padding:10px; }
    button { padding:8px 10px; border-radius:10px; border:1px solid var(--line); background:transparent; color:var(--text); cursor:pointer; }
    button:disabled { opacity:.45; cursor:not-allowed; }
    .small { font-size:12px; color:var(--muted); }
    .warn { margin-top:10px; padding:10px 12px; border:1px dashed rgba(110,231,183,.45); border-radius:12px; color:var(--muted); }
    @media (max-width: 900px){
      .controls { grid-template-columns: 1fr 1fr; }
      th { top: 140px; }
    }
  </style>
</head>

<body>
  <header>
    <h1>Fantacalcio Wendy — Lista svincolati</h1>
    <div class="controls">
      <div class="ctrl">
        <label for="q">Ricerca (nome, squadra, ruolo, valori…)</label>
        <input id="q" type="search" placeholder="Es. 'lautaro', 'Inter', 'A', '7.1'..." />
      </div>

      <div class="ctrl">
        <label for="role">Ruolo</label>
        <select id="role">
          <option value="">Tutti</option>
        </select>
      </div>

      <div class="ctrl">
        <label for="team">Squadra</label>
        <select id="team">
          <option value="">Tutte</option>
        </select>
      </div>

      <div class="ctrl">
        <label for="pageSize">Righe/pagina</label>
        <select id="pageSize">
          <option>25</option>
          <option>50</option>
          <option>100</option>
          <option>200</option>
        </select>
      </div>
    </div>
  </header>

  <main>
    <div class="meta">
      <div class="pill" id="status">Caricamento dati…</div>
      <div class="small" id="sortInfo"></div>
    </div>

    <div class="tableWrap">
      <table id="tbl">
        <thead>
          <tr id="theadRow"></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="pager">
        <span class="small" id="count"></span>
        <button id="prev">◀</button>
        <span class="small" id="page"></span>
        <button id="next">▶</button>
      </div>
    </div>

    <div class="warn">
      Nota: questa pagina legge <b>svincolati_wendy.csv</b> dalla stessa cartella.
      Per GitHub Pages: metti <b>index.html</b> e <b>svincolati_wendy.csv</b> nello stesso repo (root) e abilita Pages.
    </div>
  </main>

  <script>
    // ===== CONFIG =====
    const CSV_PATH = "./svincolati_wendy.csv"; // stesso repo/cartella
    const DEFAULT_SORT = { key: "FM", dir: "desc" }; // se la colonna esiste

    // ===== STATE =====
    let raw = [];
    let filtered = [];
    let columns = [];
    let sortState = { key: null, dir: "asc" };
    let pageState = { page: 1, pageSize: 25 };

    const el = (id) => document.getElementById(id);

    // ===== CSV PARSER (robusto abbastanza per export standard) =====
    function parseCSV(text) {
      // Gestisce virgola o ; in automatico (prende il separatore più frequente nella prima riga)
      const firstLine = text.split(/\r?\n/).find(l => l.trim().length > 0) || "";
      const comma = (firstLine.match(/,/g) || []).length;
      const semi  = (firstLine.match(/;/g) || []).length;
      const sep = semi > comma ? ";" : ",";

      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const c = text[i];
        const n = text[i+1];

        if (c === '"' && inQuotes && n === '"') { cur += '"'; i++; continue; }
        if (c === '"') { inQuotes = !inQuotes; continue; }

        if (!inQuotes && (c === "\n" || c === "\r")) {
          if (c === "\r" && n === "\n") i++;
          row.push(cur);
          rows.push(row);
          row = [];
          cur = "";
          continue;
        }

        if (!inQuotes && c === sep) {
          row.push(cur);
          cur = "";
          continue;
        }

        cur += c;
      }
      if (cur.length || row.length) { row.push(cur); rows.push(row); }

      // Trim celle
      return rows.map(r => r.map(v => (v ?? "").trim()));
    }

    function toNumberMaybe(v) {
      if (v == null) return null;
      const s = String(v).trim();
      if (!s) return null;
      // supporta virgola decimale italiana
      const norm = s.replace(/\./g, "").replace(",", ".");
      const num = Number(norm);
      return Number.isFinite(num) ? num : null;
    }

    function buildTableHeader() {
      const tr = el("theadRow");
      tr.innerHTML = "";
      columns.forEach(col => {
        const th = document.createElement("th");
        th.textContent = col;
        const hint = document.createElement("span");
        hint.className = "hint";
        hint.textContent = "↕";
        th.appendChild(hint);
        th.addEventListener("click", () => toggleSort(col));
        tr.appendChild(th);
      });
    }

    function render() {
      applyFilters();
      applySort();
      paginate();
      updateMeta();
    }

    function applyFilters() {
      const q = el("q").value.trim().toLowerCase();
      const role = el("role").value;
      const team = el("team").value;

      filtered = raw.filter(r => {
        if (role && (r["R."] ?? r["Ruolo"] ?? "") !== role) return false;
        if (team && (r["Sq."] ?? r["Squadra"] ?? "") !== team) return false;

        if (!q) return true;
        // ricerca full text su tutte le colonne
        for (const k of columns) {
          const v = r[k];
          if (v != null && String(v).toLowerCase().includes(q)) return true;
        }
        return false;
      });

      // se filtri cambiano, rientra in pagina 1
      pageState.page = 1;
    }

    function applySort() {
      const { key, dir } = sortState.key ? sortState : DEFAULT_SORT;
      const actualKey = columns.includes(key) ? key : (sortState.key || columns[0]);

      sortState.key = actualKey;
      sortState.dir = sortState.dir || (DEFAULT_SORT.dir || "asc");

      const m = sortState.dir === "asc" ? 1 : -1;

      filtered.sort((a,b) => {
        const av = a[actualKey];
        const bv = b[actualKey];

        const an = toNumberMaybe(av);
        const bn = toNumberMaybe(bv);

        if (an != null && bn != null) return (an - bn) * m;

        const as = (av ?? "").toString().toLowerCase();
        const bs = (bv ?? "").toString().toLowerCase();
        if (as < bs) return -1 * m;
        if (as > bs) return  1 * m;
        return 0;
      });
    }

    function paginate() {
      const tbody = el("tbody");
      tbody.innerHTML = "";

      const start = (pageState.page - 1) * pageState.pageSize;
      const end = start + pageState.pageSize;
      const slice = filtered.slice(start, end);

      for (const r of slice) {
        const tr = document.createElement("tr");
        columns.forEach(col => {
          const td = document.createElement("td");
          const v = r[col];

          // allinea numerici a destra se sembrano numeri
          const n = toNumberMaybe(v);
          if (n != null) td.classList.add("right");

          td.textContent = (v ?? "").toString();
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      }

      const totalPages = Math.max(1, Math.ceil(filtered.length / pageState.pageSize));
      el("prev").disabled = pageState.page <= 1;
      el("next").disabled = pageState.page >= totalPages;
      el("page").textContent = `Pagina ${pageState.page} / ${totalPages}`;
      el("count").textContent = `Risultati: ${filtered.length}`;
    }

    function updateMeta() {
      el("status").textContent = `Dataset: ${raw.length} righe — Svincolati Wendy`;
      el("sortInfo").textContent = sortState.key ? `Ordine: ${sortState.key} (${sortState.dir})` : "";
    }

    function toggleSort(col) {
      if (sortState.key === col) {
        sortState.dir = sortState.dir === "asc" ? "desc" : "asc";
      } else {
        sortState.key = col;
        sortState.dir = "asc";
      }
      render();
    }

    function populateFilters() {
      // Ruoli e Squadre dipendono da come si chiamano le colonne nel tuo CSV:
      const roleKey = columns.includes("R.") ? "R." : (columns.includes("Ruolo") ? "Ruolo" : null);
      const teamKey = columns.includes("Sq.") ? "Sq." : (columns.includes("Squadra") ? "Squadra" : null);

      const roles = new Set();
      const teams = new Set();

      raw.forEach(r => {
        if (roleKey && r[roleKey]) roles.add(r[roleKey]);
        if (teamKey && r[teamKey]) teams.add(r[teamKey]);
      });

      const roleSel = el("role");
      const teamSel = el("team");

      const sortedRoles = Array.from(roles).sort();
      const sortedTeams = Array.from(teams).sort();

      sortedRoles.forEach(v => {
        const o = document.createElement("option");
        o.value = v; o.textContent = v;
        roleSel.appendChild(o);
      });

      sortedTeams.forEach(v => {
        const o = document.createElement("option");
        o.value = v; o.textContent = v;
        teamSel.appendChild(o);
      });
    }

    async function init() {
      try {
        const res = await fetch(CSV_PATH, { cache: "no-store" });
        if (!res.ok) throw new Error(`Impossibile leggere ${CSV_PATH} (HTTP ${res.status})`);
        const text = await res.text();

        const rows = parseCSV(text).filter(r => r.some(c => c && c.trim().length > 0));
        if (rows.length < 2) throw new Error("CSV vuoto o non valido");

        columns = rows[0].map(c => c.trim());
        raw = rows.slice(1).map(r => {
          const obj = {};
          columns.forEach((c, i) => obj[c] = (r[i] ?? "").trim());
          return obj;
        });

        buildTableHeader();
        populateFilters();

        // listeners
        el("q").addEventListener("input", () => render());
        el("role").addEventListener("change", () => render());
        el("team").addEventListener("change", () => render());
        el("pageSize").addEventListener("change", (e) => {
          pageState.pageSize = Number(e.target.value);
          pageState.page = 1;
          render();
        });
        el("prev").addEventListener("click", () => { pageState.page--; paginate(); });
        el("next").addEventListener("click", () => { pageState.page++; paginate(); });

        // default sort
        if (columns.includes(DEFAULT_SORT.key)) {
          sortState.key = DEFAULT_SORT.key;
          sortState.dir = DEFAULT_SORT.dir;
        } else {
          sortState.key = columns[0];
          sortState.dir = "asc";
        }

        render();
      } catch (err) {
        el("status").textContent = "Errore caricamento dati";
        el("status").style.borderColor = "rgba(239,68,68,.5)";
        el("status").style.color = "#fecaca";
        console.error(err);
        alert(String(err.message || err));
      }
    }

    init();
  </script>
</body>
</html>
